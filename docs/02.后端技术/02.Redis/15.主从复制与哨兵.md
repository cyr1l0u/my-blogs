---
title: Redis 主从复制与哨兵
date: 2024-02-27 22:40:41
permalink: /pages/1423dd/
categories:
  - 后端技术
  - Redis
tags:
  - 
author: 
  name: erlangtui
  link: https://github.com/erlangtui
---

## 基本介绍
* 主从复制用于将主节点的数据备份到从节点，能够实现读写分离，主写从读，减轻主节点的负载；
* 主节点宕机时，从节点能够快速升级为主节点对外提供服务，实现了容灾与备份；

## 主从复制的建立与断开
* 通过配置文件建立：在从节点的配置文件中加上`slaveof {masterHost} {masterPort}`后启动 Redis 即可生效；
* 通过命令行配置：在从节点`redis-server`启动命令后加入`--slaveof{masterHost}{masterPort}`即可生效；
* 在从节点启动后，通过客户端连接到从节点后，执行`slaveof {masterHost} {masterPort}`命令后也可生效，节点重启后失效；
* 在从节点执行`slaveof no one`即可与主节点断开，或是在配置文件中删除该配置重启后生效；

## 复制流程

### 全量复制
* 主节点一次性把所有数据全部发送给从节点，一般用于初次复制的场景，性能开销和网络开销较大；
* 从节点发送psync命令进行数据同步，由于是第一次进行复制，没有复制偏移量和主节点的运行ID，所以发送psync-1；
* 主节点根据psync-1解析出当前为全量复制，回复+FULLRESYNC响应；
* 从节点接收主节点的响应数据保存运行ID和偏移量offset；
* 主节点执行bgsave保存RDB文件到本地；
* 主节点发送RDB文件给从节点，从节点把接收的RDB文件保存在本地并直接作为从节点的数据文件；
* 可以算出RDB文件从创建到传输完毕消耗的总时间。如果总时间超过repl-timeout所配置的值（默认60秒），从节点将放弃接受RDB文件并清理已经下载的临时文件，导致全量复制失败；
* 对于从节点开始接收RDB快照到接收完成期间，主节点仍然响应读写命令，因此主节点会把这期间写命令数据保存在复制客户端缓冲区内，当从节点加载完RDB文件后，主节点再把缓冲区内的数据发送给从节点，保证主从之间数据一致性。
